<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WeightedLowess: Weighted LOWESS for C++</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">WeightedLowess
   </div>
   <div id="projectbrief">A C++ library for LOWESS with various weighting schemes</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Weighted LOWESS for C++ </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2github_2workspace_2README"></a></p>
<p><img src="https://github.com/LTLA/CppWeightedLowess/actions/workflows/run-tests.yaml/badge.svg" alt="Unit tests" style="pointer-events: none;" class="inline"/> <img src="https://github.com/LTLA/CppWeightedLowess/actions/workflows/doxygenate.yaml/badge.svg" alt="Documentation" style="pointer-events: none;" class="inline"/> <img src="https://github.com/LTLA/CppWeightedLowess/actions/workflows/compare-limma.yaml/badge.svg" alt="Limma comparison" style="pointer-events: none;" class="inline"/> <a href="https://codecov.io/gh/LTLA/CppWeightedLowess"><img src="https://codecov.io/gh/LTLA/CppWeightedLowess/branch/master/graph/badge.svg?token=GBHWVK9MFY" alt="Codecov" style="pointer-events: none;" class="inline"/></a></p>
<h1>Overview</h1>
<p>This C++ library implements the Locally Weighted Scatterplot Smoothing (LOWESS) method described by Cleveland (1979, 1981). LOWESS is a non-parametric smoothing algorithm that is simple and computationally efficient yet can accommodate a wide variety of curves. The libary itself is header-only and thus can be easily used in any C++ project by adding the relevant <code>#include</code> directives. This implementation is derived from the <a href="https://bioconductor.org/packages/limma/"><b>limma</b></a> package and contains some modifications from Cleveland's original code. Of particular interest is the ability to treat the weights as frequencies such that they are involved in the window span calculations for each anchor point - hence the name.</p>
<h1>Algorithm details</h1>
<p>Cleveland's original Fortran implementation is quite simple:</p>
<ol type="1">
<li>Define a set of anchor points, more-or-less evenly spaced throughout the range of x-values.</li>
<li>Perform a local linear regression around each anchor, using only points within a window centered at each anchor. In this regression, points inside the window are weighted based on their distances from the anchor on the x-axis. (If additional sets of weights are provided, the product of weights is used for each point.) Each anchor's window must be wide enough to contain a given proportion of all points.</li>
<li>Interpolate to obtain smoothed values for all points in between two anchors.</li>
<li>Compute a robustness weight for each point based on the absolute value of its residual from the fitted value. Points with very large residuals are considered outliers and are assigned zero weight.</li>
<li>Repeat steps 1-5 using the computed weights in each anchor's local linear regression. This is iterated several times to eliminate the effect of outliers on the fit.</li>
</ol>
<p>In <code>limma::weightedLowess</code>, we implemented some (optional) modifications that are also available in this library. See the <a href="https://rdrr.io/bioc/limma/man/weightedLowess.html"><code>?weightedLowess</code> documentation</a> for more details.</p>
<ul>
<li>If additional weights are specified, we allow them to be interpreted as frequencies. As a result, the weights are used in determining the width of the smoothing window around each anchor, in addition to their usual role in the local linear regression.</li>
<li>The <code>delta</code> value can be automatically determined from a pre-specified number of anchor points. This provides a convenient way of controlling the approximation fidelity.</li>
</ul>
<p>In this library, we implement some further modifications from <code>limma::weightedLowess</code>:</p>
<ul>
<li>The number of robustness iterations in this library refers to additional iterations beyond the first fit, while the number of robustness iterations in <code>limma::weightedLowess</code> includes the first fit. So 3 iterations here are equivalent to 4 iterations in <code>limma::weightedLowess</code>.</li>
<li>We omit the early termination condition when the MAD of the residuals is much lower than the mean. This avoids inappropriate termination of the robustness iterations in pathological scenarios.</li>
<li>We provide extra protection for the edge case where the robustness weighting causes the sum of weights in a window to be zero. In such cases, we simply ignore the robustness weights when computing the smoothed value.</li>
</ul>
<h1>Usage</h1>
<p>Using this library is as simple as including the header file in your source code:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="WeightedLowess_8hpp.html">WeightedLowess/WeightedLowess.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ... standard boilerplate here...</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structWeightedLowess_1_1Options.html">WeightedLowess::Options</a> opt;</div>
<div class="line"><span class="keyword">auto</span> results = <a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, y, opt);</div>
<div class="line">results.fitted;</div>
<div class="ttc" id="aWeightedLowess_8hpp_html"><div class="ttname"><a href="WeightedLowess_8hpp.html">WeightedLowess.hpp</a></div><div class="ttdoc">LOWESS implementation with various weighting schemes.</div></div>
<div class="ttc" id="anamespaceWeightedLowess_html_ad11983a78a81e353c458a203d4f581c9"><div class="ttname"><a href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a></div><div class="ttdeci">void compute(const std::size_t num_points, const Data_ *x, const PrecomputedWindows&lt; Data_ &gt; &amp;windows, const Data_ *y, Data_ *fitted, Data_ *robust_weights, const Options&lt; Data_ &gt; &amp;opt)</div><div class="ttdef"><b>Definition</b> compute.hpp:40</div></div>
<div class="ttc" id="astructWeightedLowess_1_1Options_html"><div class="ttname"><a href="structWeightedLowess_1_1Options.html">WeightedLowess::Options</a></div><div class="ttdoc">Options for compute().</div><div class="ttdef"><b>Definition</b> Options.hpp:17</div></div>
</div><!-- fragment --><p>We can set options via the <code><a class="el" href="structWeightedLowess_1_1Options.html" title="Options for compute().">WeightedLowess::Options</a></code> object:</p>
<div class="fragment"><div class="line">opt.<a class="code hl_variable" href="structWeightedLowess_1_1Options.html#a820614e4b0971b12560f420025876549">span</a> = 0.5;</div>
<div class="line">opt.<a class="code hl_variable" href="structWeightedLowess_1_1Options.html#a5e34709595bc216d41f01fc60ca2b7fb">anchors</a> = 100;</div>
<div class="line"><span class="keyword">auto</span> results2 = <a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, y, opt);</div>
<div class="ttc" id="astructWeightedLowess_1_1Options_html_a5e34709595bc216d41f01fc60ca2b7fb"><div class="ttname"><a href="structWeightedLowess_1_1Options.html#a5e34709595bc216d41f01fc60ca2b7fb">WeightedLowess::Options::anchors</a></div><div class="ttdeci">std::size_t anchors</div><div class="ttdef"><b>Definition</b> Options.hpp:55</div></div>
<div class="ttc" id="astructWeightedLowess_1_1Options_html_a820614e4b0971b12560f420025876549"><div class="ttname"><a href="structWeightedLowess_1_1Options.html#a820614e4b0971b12560f420025876549">WeightedLowess::Options::span</a></div><div class="ttdeci">Data_ span</div><div class="ttdef"><b>Definition</b> Options.hpp:28</div></div>
</div><!-- fragment --><p>If users already have an appropriate buffer for the fitted values and robustness weights, they can be filled directly with the results:</p>
<div class="fragment"><div class="line">std::vector&lt;double&gt; fitted(num_points), rweights(num_points);</div>
<div class="line"><a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, y, fitted.data(), rweights.data(), opt);</div>
</div><!-- fragment --><p>We can also pre-compute the window locations from <code>x</code> to re-use them with different <code>y</code>, e.g., for smoothing different dimensions with a common covariate.</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> xwindows = <a class="code hl_function" href="namespaceWeightedLowess.html#a30dc5c465fd1c49a9b8a0d8e1a51e1ee">WeightedLowess::define_windows</a>(num_points, x, opt);</div>
<div class="line"><a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, xwindows, y, fitted.data(), resids.data(), opt);</div>
<div class="line"><a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, xwindows, y2, fitted2.data(), resids2.data(), opt);</div>
<div class="line"><span class="comment">// etc.</span></div>
<div class="ttc" id="anamespaceWeightedLowess_html_a30dc5c465fd1c49a9b8a0d8e1a51e1ee"><div class="ttname"><a href="namespaceWeightedLowess.html#a30dc5c465fd1c49a9b8a0d8e1a51e1ee">WeightedLowess::define_windows</a></div><div class="ttdeci">PrecomputedWindows&lt; Data_ &gt; define_windows(const std::size_t num_points, const Data_ *x, const Options&lt; Data_ &gt; &amp;opt)</div><div class="ttdef"><b>Definition</b> window.hpp:267</div></div>
</div><!-- fragment --><p>The <code>compute()</code> function assumes that the input x-coordinates are already sorted. If this is not the case, we can use the <code>SortBy</code> class to sort the input and unsort the output:</p>
<div class="fragment"><div class="line"><span class="comment">// Permuting the x/y pairs so that x is sorted:</span></div>
<div class="line"><a class="code hl_class" href="classWeightedLowess_1_1SortBy.html">WeightedLowess::SortBy</a> sorter(num_points, x);</div>
<div class="line">std::vector&lt;uint8_t&gt; workspace;</div>
<div class="line">sorter.permute(x, workspace);</div>
<div class="line">sorter.permute(y, workspace);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> res_unsrt = <a class="code hl_function" href="namespaceWeightedLowess.html#ad11983a78a81e353c458a203d4f581c9">WeightedLowess::compute</a>(num_points, x, y, opt);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Unpermuting the fitted values and robustness weights to match</span></div>
<div class="line"><span class="comment">// the original ordering of x/y pairs.</span></div>
<div class="line">sorter.unpermute(res_unsrt.fitted.data(), workspace);</div>
<div class="line">sorter.unpermute(res_unsrt.robust_weights.data(), workspace);</div>
<div class="ttc" id="aclassWeightedLowess_1_1SortBy_html"><div class="ttname"><a href="classWeightedLowess_1_1SortBy.html">WeightedLowess::SortBy</a></div><div class="ttdoc">Utility class for sorting on a covariate.</div><div class="ttdef"><b>Definition</b> SortBy.hpp:32</div></div>
</div><!-- fragment --><p>See the <a href="https://ltla.github.io/CppWeightedLowess">reference documentation</a> for more details.</p>
<h1>Building projects</h1>
<h2>CMake with <code>FetchContent</code></h2>
<p>If you're already using CMake, you can add something like this to your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line"> </div>
<div class="line">FetchContent_Declare(</div>
<div class="line">  WeightedLowess </div>
<div class="line">  GIT_REPOSITORY https://github.com/LTLA/CppWeightedLowess</div>
<div class="line">  GIT_TAG master # or any version of interest</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">FetchContent_MakeAvailable(tatami)</div>
</div><!-- fragment --><p>And then:</p>
<div class="fragment"><div class="line"># For executables:</div>
<div class="line">target_link_libraries(myexe WeightedLowess)</div>
<div class="line"> </div>
<div class="line"># For libaries</div>
<div class="line">target_link_libraries(mylib INTERFACE WeightedLowess)</div>
</div><!-- fragment --><h2>CMake with <code>find_package()</code></h2>
<p>You can install the library by cloning a suitable version of this repository and running the following commands:</p>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake .. -DWEIGHTEDLOWESS_TESTS=OFF</div>
<div class="line">cmake --build . --target install</div>
</div><!-- fragment --><p>Then you can use <code>find_package()</code> as usual:</p>
<div class="fragment"><div class="line">find_package(ltla_WeightedLowess CONFIG REQUIRED)</div>
<div class="line">target_link_libraries(mylib INTERFACE ltla::WeightedLowess)</div>
</div><!-- fragment --><p>By default, this will use <code>FetchContent</code> to fetch all external dependencies. If you want to install them manually, use <code>-DWEIGHTEDLOWESS_FETCH_EXTERN=OFF</code>. See <a href="extern/CMakeLists.txt"><code>extern/CMakeLists.txt</code></a> to find compatible versions of each dependency.</p>
<h2>Manual</h2>
<p>If you're not using CMake, the simple approach is to just copy the files in the [<code>include/</code>](include) subdirectory - either directly or with Git submodules - and include their path during compilation with, e.g., GCC's <code>-I</code>. This requires the external dependencies listed in <a href="extern/CMakeLists.txt"><code>extern/CMakeLists.txt</code></a>, which also need to be made available during compilation.</p>
<h1>References</h1>
<p>Cleveland, W.S. (1979). Robust locally weighted regression and smoothing scatterplots. <em>Journal of the American Statistical Association</em> 74(368), 829-836.</p>
<p>Cleveland, W.S. (1981). LOWESS: A program for smoothing scatterplots by robust locally weighted regression. <em>The American Statistician</em> 35(1), 54. </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
